<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>YCSEP DB</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
  <link rel="manifest" href="/static/site.webmanifest">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
        crossorigin="anonymous">
  <style>
    body { margin: 16px; font-size: 0.9rem; }
    th { cursor: pointer; }
    .audio-cell audio { width: 160px; }
    .sort-indicator { font-size: 0.7rem; color: #999; margin-left: 4px; }
    /* keep long text readable */
    td { vertical-align: top; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<body class="container">

  <!-- Fair Use / Usage notice (always shown; dismissable) -->
  <div class="alert alert-warning alert-dismissible fade show text-center m-0 rounded-0" role="alert" style="z-index:1050;">
    <strong>Notice:</strong> This site contains copyrighted material made available for research, scholarship, and teaching under applicable laws (e.g., Singapore Copyright Act 2021; EU Directive 2019/790; U.S. 17 U.S.C. §107).
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <div class="d-flex justify-content-between align-items-end mb-3">
    <h1 class="h3">YCSEP DB Results</h1>
    <small class="text-muted text-end" style="max-width: 60%;">
      This database contains transcript segments with associated audio from the <i>YouTube Corpus of Singapore English Podcasts</i>s. You can search by transcript text (e.g. <code>I just think</code>) or POS tags (e.g. <code>PRP RB VB</code>). Use the buttons to download a csv and audio for the current page. For more information about the resource, see Coats, Steven, Carmelo Alessandro Basile, Cameron Morin and Robert Fuchs. (2025). The YouTube Corpus of Singapore English Podcasts. <i>English World-Wide</i>. <a href="https://doi.org/10.1075/eww.25018.coa">https://doi.org/10.1075/eww.25018.coa</a>. A static version of the corpus is available at <a href="https://doi.org/10.7910/DVN/B7JRID">doi.org/10.7910/DVN/B7JRID</a>
    </small>
  </div>

  <div class="row mb-2">
    <div class="col-auto">
      <label for="searchInput" class="form-label">Search text:</label>
      <input type="text" id="searchInput" class="form-control" placeholder='Search text or POS tags (e.g. can can or "pos tag")'>
    </div>
    <div class="col-auto align-self-end">
      <button class="btn btn-primary" onclick="doSearch()">Search</button>
    </div>
  </div>

  <!-- Filter by Channel -->
  <div class="mb-2">
    <strong>Filter by Channel:</strong>
    <div id="channelCheckboxes" class="d-flex flex-wrap gap-3 mt-2"></div>
  </div>

  <!-- Download buttons (current page) -->
  <div class="mb-3 d-flex gap-2">
    <a id="csvBtn" href="#" class="btn btn-outline-success btn-sm d-none">Download CSV (Page)</a>
    <a id="mp3Btn" href="#" class="btn btn-outline-primary btn-sm d-none">Download MP3s (Page)</a>
  </div>

  <div class="mb-2 text-muted" id="hitCount">Loading results...</div>

  <table class="table table-bordered table-striped table-hover table-sm" id="dataTable">
    <thead class="table-dark">
      <tr>
        <th onclick="sortBy('id')">ID<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('channel')">Channel<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('video_id')">Video ID<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('speaker')">Speaker<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('start_time')">Start<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('end_time')">End<span class="sort-indicator">▴▾</span></th>
        <th>Audio</th>
        <th onclick="sortBy('text')">Text<span class="sort-indicator">▴▾</span></th>
        <th onclick="sortBy('pos_tags')">POS<span class="sort-indicator">▴▾</span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="d-flex justify-content-center my-3" id="paginationControls"></div>

  <script>
    let currentPage = 1;
    let totalRows = 0;
    let pageSize = 100;
    let currentSort = 'id';
    let currentDirection = 'asc';

    function getSelectedChannels() {
      const boxes = document.querySelectorAll('#channelCheckboxes input[type=checkbox]:checked');
      return Array.from(boxes).map(cb => cb.value);
    }

    function doSearch() {
      currentPage = 1;
      loadData();
    }

    function sortBy(column) {
      if (currentSort === column) {
        currentDirection = (currentDirection === 'asc') ? 'desc' : 'asc';
      } else {
        currentSort = column;
        currentDirection = 'asc';
      }
      currentPage = 1;
      loadData();
    }

    function goPage(page) {
      if (page < 1) return;
      const totalPages = Math.ceil(totalRows / pageSize);
      if (page > totalPages) return;
      currentPage = page;
      loadData();
    }

    function loadData() {
      const inputEl = document.getElementById('searchInput');
      const textVal = inputEl.value.trim();
      const selected = getSelectedChannels();
      const channelsParam = encodeURIComponent(selected.join(','));

      const url = `/data?page=${currentPage}&size=${pageSize}` +
                  `&text=${encodeURIComponent(textVal)}` +
                  `&sort=${currentSort}&direction=${currentDirection}` +
                  `&channels=${channelsParam}`;

      fetch(url)
        .then(res => res.json())
        .then(json => {
          totalRows = json.total;
          renderTable(json.data);
          renderPagination();
          renderHitCount();
          updateDownloadLinks(textVal, channelsParam);
        })
        .catch(err => console.error('Error fetching /data:', err));
    }

    function updateDownloadLinks(textVal, channelsParam) {
      const csvBtn = document.getElementById('csvBtn');
      const mp3Btn = document.getElementById('mp3Btn');
      csvBtn.href = `/download/csv?page=${currentPage}&size=${pageSize}` +
                    `&text=${encodeURIComponent(textVal)}` +
                    `&channels=${channelsParam}`;
      mp3Btn.href = `/download/mp3zip?page=${currentPage}&size=${pageSize}` +
                    `&text=${encodeURIComponent(textVal)}` +
                    `&channels=${channelsParam}`;
      csvBtn.classList.remove('d-none');
      mp3Btn.classList.remove('d-none');
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function renderTable(rows) {
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';

      rows.forEach(r => {
        // IMPORTANT FIX:
        // Use the backend-provided audio_url from the segments DB.
        // The old /audio/{id} endpoint returns 400 by design.
        const audioUrl = r.audio_url || '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.id)}</td>
          <td>${escapeHtml(r.channel)}</td>
          <td class="mono">${escapeHtml(r.video_id)}</td>
          <td>${escapeHtml(r.speaker)}</td>
          <td>${escapeHtml(r.start_time)}</td>
          <td>${escapeHtml(r.end_time)}</td>
          <td class="audio-cell">
            ${audioUrl ? `
              <audio controls preload="none">
                <source src="${escapeHtml(audioUrl)}" type="audio/wav">
              </audio>
            ` : ''}
          </td>
          <td>${escapeHtml(r.text)}</td>
          <td class="mono">${escapeHtml(r.pos_tags)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderPagination() {
      const container = document.getElementById('paginationControls');
      container.innerHTML = '';

      const totalPages = Math.ceil(totalRows / pageSize);
      if (totalPages <= 1) return;

      const nav = document.createElement('nav');
      nav.setAttribute('aria-label', 'Results pages');

      const ul = document.createElement('ul');
      ul.className = 'pagination pagination-sm justify-content-center';

      const makeItem = (label, targetPage, disabled=false, active=false, ariaLabel=null) => {
        const li = document.createElement('li');
        li.className = 'page-item';
        if (disabled) li.classList.add('disabled');
        if (active) li.classList.add('active');

        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        if (ariaLabel) a.setAttribute('aria-label', ariaLabel);
        a.textContent = label;

        if (!disabled && !active) {
          a.addEventListener('click', (e) => { e.preventDefault(); goPage(targetPage); });
        }

        li.appendChild(a);
        return li;
      };

      const addEllipsis = () => {
        const li = document.createElement('li');
        li.className = 'page-item disabled';
        const span = document.createElement('span');
        span.className = 'page-link';
        span.textContent = '…';
        li.appendChild(span);
        ul.appendChild(li);
      };

      // First / Prev
      ul.appendChild(makeItem('«', 1, currentPage === 1, false, 'First'));
      ul.appendChild(makeItem('‹', Math.max(1, currentPage - 1), currentPage === 1, false, 'Previous'));

      // Numbered pages with ellipses
      const windowSize = 2; // show current ±2
      let start = Math.max(1, currentPage - windowSize);
      let end = Math.min(totalPages, currentPage + windowSize);

      if (start > 1) {
        ul.appendChild(makeItem('1', 1, false, currentPage === 1, 'Page 1'));
        if (start > 2) addEllipsis();
      }

      for (let p = start; p <= end; p++) {
        ul.appendChild(makeItem(String(p), p, false, p === currentPage, `Page ${p}`));
      }

      if (end < totalPages) {
        if (end < totalPages - 1) addEllipsis();
        ul.appendChild(makeItem(String(totalPages), totalPages, false, currentPage === totalPages, `Page ${totalPages}`));
      }

      // Next / Last
      ul.appendChild(makeItem('›', Math.min(totalPages, currentPage + 1), currentPage === totalPages, false, 'Next'));
      ul.appendChild(makeItem('»', totalPages, currentPage === totalPages, false, 'Last'));

      nav.appendChild(ul);
      container.appendChild(nav);
    }

    function renderHitCount() {
      const counter = document.getElementById('hitCount');
      counter.textContent = `${totalRows} results found.`;
    }

    function loadChannels() {
      fetch('/channels')
        .then(res => res.json())
        .then(channels => {
          const container = document.getElementById('channelCheckboxes');
          container.innerHTML = '';
          channels.forEach(c => {
            const label = document.createElement('label');
            label.classList.add('form-check', 'me-3');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.classList.add('form-check-input', 'me-1');
            checkbox.value = c;
            checkbox.checked = true;
            checkbox.addEventListener('change', doSearch);
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(c));
            container.appendChild(label);
          });
        })
        .catch(err => console.error('Failed to load channels:', err));
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadChannels();
      loadData();
      document.getElementById('searchInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') doSearch();
      });
    });
  </script>
</body>
</html>
